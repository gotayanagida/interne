<meta charset='utf-8' />
<link href='http://homin.sakura.ne.jp/cal/fullcalendar-3.6.1/fullcalendar.min.css' rel='stylesheet' />
<link href='http://homin.sakura.ne.jp/cal/fullcalendar-3.6.1/fullcalendar.print.min.css' rel='stylesheet' media='print' />
<!-- BootstrapのCSS読み込み -->
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<!-- jQuery読み込み -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- BootstrapのJS読み込み -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="http://underscorejs.org/underscore-min.js"></script>
<script src='http://homin.sakura.ne.jp/cal/fullcalendar-3.6.1/lib/moment.min.js'></script>
<script src='http://homin.sakura.ne.jp/cal/fullcalendar-3.6.1/lib/jquery.min.js'></script>
<script src='http://homin.sakura.ne.jp/cal/fullcalendar-3.6.1/fullcalendar.min.js'></script>
<script src='http://homin.sakura.ne.jp/cal/fullcalendar-3.6.1/locale/ja.js'></script>
<!--http://uiureo.hatenablog.com/entry/2012/05/24/231436-->
<script src='http://chancejs.com/chance.min.js'></script>

<style type="text/css">
html, body {
        overflow: auto;
    }
    #wrapper {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: auto;
    }
    * html #tooltip {
        position: absolute;
    }
    #tooltip {
        position: fixed;
				background-color: white;
				border: dashed 1px black;
        opacity: 80;
        z-index: 100;
    }
		.fc-today {
	    background: #ffffc0 !important;
	    font-weight: bold;
		}
</style>

<script>
  //ユニークなkey取得
	const tallyTarget = target => {
		// ObjectからKeyを重複なく取得
		const keys = _.uniq(_.flatten(target.map(t => Object.keys(t))))
		// keyで抽出する(pluck)
		const result = {}
		keys.forEach(k => result[k] = _.compact(_.map(target, k)))
		return result
	};
	//時間の数字の０詰め
	var toDoubleDigits = function(num) {
	  num += "";
	  if (num.length === 1) {
	    num = "0" + num;
	  }
	 return num;
	};
  shoya1 = [
		{
			title: '川端真司',
			start: '2017-10-23T10:00:00',
			end: '2017-10-23T15:00:00'
		},
		{
			title: '佐藤衆望',
			start: '2017-10-23T13:00:00',
			end: '2017-10-23T19:00:00'
		},
		{
			title: '佐藤翔野',
			start: '2017-10-23T14:00:00',
			end: '2017-10-23T16:00:00'
		},
		{
			title: '柳田豪太',
			start: '2017-10-23T09:30:00',
			end: '2017-10-23T21:30:00'
		},
		{
			title: '佐藤衆望',
			start: '2017-10-24T08:00:00',
			end: '2017-10-24T12:00:00'
		},
		{
			title: '関梢',
			start: '2017-10-24T19:30:00',
			end: '2017-10-24T20:00:00'
		},
	];
	
	shoya =[
	<% @schedules.each do |schedule| %>
      {
      	title:'<%= schedule.user %>',
      	start:'<%= schedule.work_started_at %>',
      	end:'<%= schedule.work_ended_at %>'
      },
    <% end %>
	
	];



	$(document).ready(function() {
		var nowdate = new Date();

		event_perse = tallyTarget(shoya);
		uniq_title = _.uniq(event_perse.title);

		for(var i=0;i<uniq_title.length;i++){
			sex = (uniq_title[i].charCodeAt(0)+uniq_title[i].charCodeAt(uniq_title[i].length-1))/3;
			var my_chance=new Chance(sex);
			var mycolor = my_chance.color({format: 'hex'});
			var $input = $('<input type="checkbox" />').attr({id: uniq_title[i],name:"check"}).attr("checked", true );
			var $label = $('<label><font color='+mycolor+'>■</font>'+uniq_title[i]+'</label></br>');
			$("#inputtest").append($input).append($label);
		}

		//配列整形→色挿入
		for(var i=0;i<shoya.length;i++){
			sex = (shoya[i].title.charCodeAt(0)+shoya[i].title.charCodeAt(shoya[i].title.length-1))/8;
			var my_chance=new Chance(sex);
			shoya[i].color = my_chance.color({format: 'hex'});
			start = new Date(Date.parse(shoya[i].start));
			end = new Date(Date.parse(shoya[i].end));
			shoya[i].tooltip = '<div id="tooltip">'+shoya[i].title+'<br/>'+toDoubleDigits(start.getHours())+':'+toDoubleDigits(start.getMinutes())+'-'+toDoubleDigits(end.getHours())+':'+toDoubleDigits(end.getMinutes());
		}


		$('#calendar').fullCalendar({
			header: {
				left: 'prev,next today',
				center: 'title',
				right: 'agendaWeek,agendaDay,month'
			},
			defaultView: 'agendaWeek',
			lang: "ja",
			slotEventOverlap: false,
			displayEventTime: false,
			allDaySlot: false,
			minTime: '07:00:00',
			maxTime: '21:00:00',
			defaultDate: nowdate.getFullYear()+'-'+(nowdate.getMonth() + 1)+'-'+nowdate.getDate(),
			navLinks: false, // can click day/week names to navigate views
			editable: false,
			eventLimit: true, // allow "more" link when too many events
			views: {
		        agenda: {
		            eventLimit: 2 // adjust to 6 only for agendaWeek/agendaDay
		        },
		        week: {
		            // options apply to basicWeek and agendaWeek views
		            eventLimit: 2
		        },
		    },
		    eventMouseover: function(calEvent, jsEvent) {
		        $('body').prepend(calEvent.tooltip);

		        xOffset = 10 + $('#tooltip').height();
		        yOffset = -10;

		        $('#tooltip')
		        .css('top', (jsEvent.clientY - xOffset) + 'px')
		        .css('left', (jsEvent.clientX + yOffset) + 'px')
		        .fadeIn();
		    },

		    eventMouseout: function(calEvent, jsEvent) {
		        $('#tooltip').remove();
		    },
			events:shoya,
		});

	});

	$(function() {
	  // チェックボックスをチェックしたら発動
	  $('input[name="check"]').change(function() {
			var new_event = []
			for(var i=0;i<uniq_title.length;i++){
				if($('#'+uniq_title[i]).prop('checked')){
					for(var j=0;j<shoya.length;j++){
						if(uniq_title[i]===shoya[j].title){
							new_event.push(shoya[j]);
						}
					}
				}
			}
			$('#calendar').fullCalendar( 'removeEvents' )
			$('#calendar').fullCalendar( 'renderEvents', new_event,'stick' );
	  });

	});

</script>
<style>

	body {
		margin: 40px 10px;
		padding: 0;
		font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
		font-size: 14px;
	}

	#calendar {
		max-width: 1200px;
		margin: 0 auto;
	}

</style>

<div class="row">
	    <div class="col-sm-2" style="background-color:white;">
					 <div id="inputtest"></div>
			</div>
	    <div class="col-sm-10" id='calendar'></div>
	  </div>




<!--
<p id="notice"><%= notice %></p>

<table>
  <thead>
    <tr>
      <th>User</th>
      <th>Work started at</th>
      <th>Work ended at</th>
      <th colspan="3"></th>
    </tr>
  </thead>

  <tbody>
    <% @schedules.each do |schedule| %>
      <tr>
        <td><%= schedule.user %></td>
        <td><%= schedule.work_started_at %></td>
        <td><%= schedule.work_ended_at %></td>
        <td><%= link_to 'Show', schedule %></td>
        <td><%= link_to 'Edit', edit_schedule_path(schedule) %></td>
        <td><%= link_to 'Destroy', schedule, method: :delete, data: { confirm: 'Are you sure?' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<br>

<%= link_to 'New Schedule', new_schedule_path %>-->
